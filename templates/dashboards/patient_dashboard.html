{% extends 'base.html' %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card text-white bg-primary">
            <div class="card-body">
                <h6>就诊记录</h6>
                <h3>{{ total_visits }}</h3>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-white bg-success">
            <div class="card-body">
                <h6>处方总数</h6>
                <h3>{{ total_prescriptions }}</h3>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-white bg-info">
            <div class="card-body">
                <h6>账单总数</h6>
                <h3>{{ total_invoices }}</h3>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-white bg-warning">
            <div class="card-body">
                <h6>待支付</h6>
                <h3>{{ unpaid_invoices }}</h3>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-6">
        <div class="card shadow-sm">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0"><i class="bi bi-person-circle"></i> 个人信息</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>姓名：</strong>{{ patient.name }}</p>
                        <p><strong>患者编号：</strong>{{ patient.patient_no }}</p>
                        <p><strong>性别：</strong>{% if patient.gender == 'M' %}男{% else %}女{% endif %}</p>
                        <p><strong>年龄：</strong>{{ patient.age }}岁</p>
                        <p><strong>电话：</strong>{{ patient.phone|default:"未填写" }}</p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>血型：</strong>{{ patient.blood_type|default:"未填写" }}</p>
                        <p><strong>过敏史：</strong>{{ patient.allergy_history|default:"无"|truncatewords:5 }}</p>
                        <p><strong>既往病史：</strong>{{ patient.medical_history|default:"无"|truncatewords:5 }}</p>
                    </div>
                </div>
                <hr>
                <a href="{% url 'patient_edit_profile' %}" class="btn btn-primary"><i class="bi bi-pencil-square"></i> 编辑个人信息</a>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card shadow-sm">
            <div class="card-header bg-white">
                <h5 class="mb-0"><i class="bi bi-grid"></i> 快捷功能</h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <a href="{% url 'patient_visits' %}" class="btn btn-outline-primary">
                        <i class="bi bi-clock-history"></i> 查看所有就诊记录
                    </a>
                    <a href="{% url 'patient_prescriptions' %}" class="btn btn-outline-success">
                        <i class="bi bi-file-earmark-medical"></i> 查看我的处方
                    </a>
                    <a href="{% url 'patient_invoices' %}" class="btn btn-outline-info">
                        <i class="bi bi-receipt"></i> 查看我的账单
                    </a>
                    <a href="#" class="btn btn-outline-warning">
                        <i class="bi bi-calendar-plus"></i> 预约挂号（待开发）
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card shadow-sm">
            <div class="card-header bg-white">
                <h5 class="mb-0"><i class="bi bi-clock-history"></i> 最近就诊记录</h5>
            </div>
            <div class="card-body">
                {% if recent_visits %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>就诊编号</th>
                                <th>就诊时间</th>
                                <th>科室</th>
                                <th>诊断</th>
                                <th>状态</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for visit in recent_visits %}
                            <tr>
                                <td>{{ visit.visit_no }}</td>
                                <td>{{ visit.visit_time|date:"Y-m-d H:i" }}</td>
                                <td>{{ visit.department|default:"未指定" }}</td>
                                <td>{{ visit.diagnosis|default:"未诊断"|truncatewords:5 }}</td>
                                <td>
                                    {% if visit.status == 'open' %}
                                        <span class="badge bg-warning">进行中</span>
                                    {% elif visit.status == 'closed' %}
                                        <span class="badge bg-success">已完成</span>
                                    {% else %}
                                        <span class="badge bg-secondary">已取消</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <a href="{% url 'patient_detail' visit.patient.id %}" class="btn btn-sm btn-outline-info">查看详情</a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="text-muted">暂无就诊记录</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

