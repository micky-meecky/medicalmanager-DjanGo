{% extends 'base.html' %}

{% block content %}
<div class="row">
    <div class="col-md-10 offset-md-1">
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-receipt"></i> 发票详情</h5>
                <a href="{% url 'patient_invoices' %}" class="btn btn-sm btn-outline-secondary">返回</a>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <p><strong>发票编号：</strong>{{ invoice.invoice_no }}</p>
                        <p><strong>就诊时间：</strong>{{ invoice.visit.visit_time|date:"Y-m-d H:i" }}</p>
                        <p><strong>开票时间：</strong>{{ invoice.issued_at|date:"Y-m-d H:i"|default:"未开票" }}</p>
                        <p><strong>开票人：</strong>{{ invoice.issued_by.name|default:"未指定" }}</p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>总金额：</strong><span class="h4 text-primary">¥{{ invoice.total_amount|floatformat:2 }}</span></p>
                        <p><strong>状态：</strong>
                            {% if invoice.status == 'unpaid' %}
                                <span class="badge bg-warning">未支付</span>
                            {% elif invoice.status == 'paid' %}
                                <span class="badge bg-success">已支付</span>
                            {% else %}
                                <span class="badge bg-danger">已退款</span>
                            {% endif %}
                        </p>
                        {% if invoice.paid_at %}
                        <p><strong>支付完成时间：</strong>{{ invoice.paid_at|date:"Y-m-d H:i" }}</p>
                        {% endif %}
                    </div>
                </div>
                
                {% if invoice.notes %}
                <div class="alert alert-info">
                    <strong>备注：</strong>{{ invoice.notes }}
                </div>
                {% endif %}
                
                {% if invoice.status == 'unpaid' %}
                <div class="text-center mt-3">
                    <a href="{% url 'patient_payment' invoice.id %}" class="btn btn-primary btn-lg">
                        <i class="bi bi-credit-card"></i> 立即支付
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
        
        {% if prescription %}
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-white">
                <h5 class="mb-0"><i class="bi bi-file-earmark-medical"></i> 关联处方</h5>
            </div>
            <div class="card-body">
                <p><strong>处方编号：</strong>{{ prescription.prescription_no }}</p>
                <p><strong>开方医生：</strong>{{ prescription.doctor.name|default:"未指定" }}</p>
                <a href="{% url 'patient_prescription_detail' prescription.id %}" class="btn btn-sm btn-outline-info">查看处方详情</a>
            </div>
        </div>
        {% endif %}
        
        {% if payments %}
        <div class="card shadow-sm">
            <div class="card-header bg-white">
                <h5 class="mb-0"><i class="bi bi-cash-coin"></i> 支付记录</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>支付时间</th>
                                <th>支付金额</th>
                                <th>支付方式</th>
                                <th>收款人</th>
                                <th>备注</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for payment in payments %}
                            <tr>
                                <td>{{ payment.paid_at|date:"Y-m-d H:i" }}</td>
                                <td class="fw-bold">¥{{ payment.amount|floatformat:2 }}</td>
                                <td>{{ payment.get_method_display }}</td>
                                <td>{{ payment.received_by.name|default:"未指定" }}</td>
                                <td>{{ payment.note|default:"-" }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

