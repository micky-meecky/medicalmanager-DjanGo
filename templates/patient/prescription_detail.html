{% extends 'base.html' %}

{% block content %}
<div class="row">
    <div class="col-md-10 offset-md-1">
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-file-earmark-medical"></i> 处方详情</h5>
                <a href="{% url 'patient_prescriptions' %}" class="btn btn-sm btn-outline-secondary">返回</a>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <p><strong>处方编号：</strong>{{ prescription.prescription_no }}</p>
                        <p><strong>就诊时间：</strong>{{ prescription.visit.visit_time|date:"Y-m-d H:i" }}</p>
                        <p><strong>开方医生：</strong>{{ prescription.doctor.name|default:"未指定" }}</p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>开具时间：</strong>{{ prescription.issued_at|date:"Y-m-d H:i"|default:"未开具" }}</p>
                        <p><strong>发药时间：</strong>{{ prescription.dispensed_at|date:"Y-m-d H:i"|default:"未发药" }}</p>
                        <p><strong>状态：</strong>
                            {% if prescription.status == 'draft' %}
                                <span class="badge bg-secondary">草稿</span>
                            {% elif prescription.status == 'issued' %}
                                <span class="badge bg-warning">已开具</span>
                            {% elif prescription.status == 'dispensed' %}
                                <span class="badge bg-success">已发药</span>
                            {% else %}
                                <span class="badge bg-danger">已取消</span>
                            {% endif %}
                        </p>
                    </div>
                </div>
                
                {% if prescription.notes %}
                <div class="alert alert-info">
                    <strong>备注：</strong>{{ prescription.notes }}
                </div>
                {% endif %}
            </div>
        </div>
        
        <div class="card shadow-sm">
            <div class="card-header bg-white">
                <h5 class="mb-0"><i class="bi bi-capsule"></i> 处方药品</h5>
            </div>
            <div class="card-body">
                {% if items %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>药品名称</th>
                                <th>规格</th>
                                <th>数量</th>
                                <th>单价</th>
                                <th>小计</th>
                                <th>用法用量</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in items %}
                            <tr>
                                <td>{{ item.drug.name }}</td>
                                <td>{{ item.drug.specification|default:"-" }}</td>
                                <td>{{ item.quantity }} {{ item.drug.unit|default:"" }}</td>
                                <td>¥{{ item.unit_price|floatformat:2 }}</td>
                                <td>¥{% widthratio item.unit_price 1 item.quantity %}</td>
                                <td>{{ item.dosage|default:"按医嘱" }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                        <tfoot>
                            <tr class="table-info">
                                <td colspan="4" class="text-end"><strong>合计：</strong></td>
                                <td><strong>¥{{ total_amount|floatformat:2 }}</strong></td>
                                <td></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
                {% else %}
                <p class="text-muted">暂无药品</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

