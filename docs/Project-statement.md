# MedicalManager 项目规划书（Project Statement / Plan）

## 1. 项目概述
### 1.1 项目名称
MedicalManager - 智能化医疗管理系统（中小型 HIS）

### 1.2 项目目标
面向中小型医疗机构，提供“患者—诊疗—药房—财务”的业务闭环管理能力，实现以下目标：
- 患者信息可追溯：建立患者档案与就诊记录
- 诊疗流程可记录：医生接诊、诊断、开具处方形成完整链路
- 药品库存可控：药品字典、库存记录、发药扣减与预警
- 收费结算可核算：账单生成、缴费记录与基础统计

### 1.3 项目范围（本次期末实现边界）
本项目聚焦四大模块，暂不考虑部署、医保接口、电子病历标准化、复杂排班与多院区等高级功能。

- 病患信息管理（Patients）
- 医院职工管理（Staff）
- 药物管理（Pharmacy）
- 财务管理（Finance）

### 1.4 项目特色与设计原则
- 模块化：按业务域拆分为 patients / staff / pharmacy / finance 四个 Django app
- 数据一致性优先：库存扣减、账单状态变更采用事务保障
- 审计可追溯：核心操作记录操作人、时间、关联业务单据号
- 最小可用闭环（MVP）：确保可演示的“就诊→处方→发药→收费”闭环跑通

---

## 2. 角色与权限设计
### 2.1 用户角色
- 管理员 Admin：系统配置、全局管理
- 医生 Doctor：就诊记录、开具处方
- 药房 Pharmacist：药品管理、库存管理、发药
- 财务 Cashier/Finance：账单生成、收费、收款记录、统计

### 2.2 权限策略（简化）
- 使用 Django 登录体系（auth.User）
- staff_profile 记录岗位角色 role，作为菜单/页面访问控制依据
- 关键写操作限制：
  - 开处方：仅 Doctor
  - 发药扣库存：仅 Pharmacist
  - 收费结算：仅 Finance
  - 职工/基础字典管理：仅 Admin

---

## 3. 业务流程（核心闭环）
### 3.1 主流程：就诊→处方→发药→收费
1. 患者建档：录入患者基本信息（patients），包括联系方式、紧急联系人、血型等
2. 创建就诊记录：绑定患者、医生、科室、主诉/诊断、复诊日期（patients）
3. 医生开具处方：为本次就诊创建处方与处方明细（pharmacy），记录开方医生、开具时间、处方备注
4. 药房发药：依据处方明细扣减库存，更新处方状态为"已发药"，记录发药时间（pharmacy）
5. 生成账单：根据处方明细（药费）+ 可选诊疗费生成账单与账单明细（finance）
6. 支付记录：登记支付方式、金额、时间与收款人，账单状态更新（finance）

### 3.2 关键状态设计（用于验收）
- visit.status：open / closed / cancelled
- prescription.status：draft / issued / dispensed / cancelled
- invoice.status：unpaid / paid / refunded（退款可选不做，默认不实现）

---

## 4. 功能需求清单（按模块拆解）
> 说明：为保证期末可交付，功能按“必须实现 / 可选加分”分级

### 4.1 病患信息管理（patients）
必须实现：
- 患者建档：新增/编辑/查看/搜索（姓名/电话/证件号）
- 就诊记录：新增/查看（绑定患者、医生、科室、诊断等）
- 患者详情页：展示患者基本信息 + 历史就诊列表

可选加分：
- 过敏史、既往史字段
- 患者编号 patient_no 自动生成并唯一

### 4.2 医院职工管理（staff）
必须实现：
- 职工档案：新增/编辑/查看（工号、姓名、岗位、科室、职位/职称、专业特长、电话、邮箱、地址、入职日期、状态）
- 登录账号与职工绑定：User ↔ StaffProfile（1:1）
- 菜单级权限控制（不同岗位看到不同入口）

可选加分：
- 职工停用后不可执行关键操作
- 简单日志：记录关键操作人（开处方/发药/收款）
- 按科室/职位筛选职工
- 职工信息导出

### 4.3 药物管理（pharmacy）
必须实现：
- 药品字典：新增/编辑/查看（编码、名称、分类、规格、单位、采购价、售价、生产厂家、是否处方药）
- 库存记录：药品当前库存数量展示、存放位置/货架号
- 入库：增加库存并记录库存流水（in）
- 发药：从处方生成发药单、扣库存并记录库存流水（out）
- 处方管理：开具处方（关联医生、就诊记录）、处方项（药品、数量、单价、用法用量、备注）
- 处方状态跟踪：草稿→已开具→已发药（记录开具时间、发药时间）

可选加分：
- 低库存预警：低于 warning_level 标红
- 处方单价冻结：prescription_item.unit_price 保存当时售价
- 药品分类管理：按分类筛选和统计
- 利润分析：基于采购价和售价计算利润

### 4.4 财务管理（finance）
必须实现：
- 账单生成：为就诊生成账单（含账单明细），记录开票人、开票时间
- 支付登记：支付记录（方式、金额、时间、收款人、备注）
- 账单状态变更：未支付→已支付（记录支付完成时间）
- 发票备注：支持添加发票备注信息

可选加分：
- 日收入统计：按日期汇总支付金额
- 按科室/医生的收入汇总（简单版）
- 按收款人统计收入
- 发票打印功能

---

## 5. 数据库设计原则与一致性约束（摘要版）
### 5.1 数据一致性核心规则
- 库存不可为负：发药前校验库存数量 >= 发药数量
- 发药与库存流水原子化：扣库存 + 写流水 + 更新处方状态必须在同一事务内完成
- 账单金额可追溯：账单总额 = 明细汇总；支付记录与账单状态一致

### 5.2 关键约束（示例）
- patient.patient_no 唯一
- patient.id_number 唯一（身份证号）
- staff.staff_no 唯一
- drug.drug_code 唯一
- visit.visit_no 唯一
- prescription.prescription_no 唯一
- invoice.invoice_no 唯一
- inventory.drug_id 唯一（每个药品只有一条库存记录）
- prescription_item (prescription_id, drug_id) 唯一（同一处方中同一药品只能出现一次）

### 5.3 核心字段说明
**患者（Patient）**：
- 基本信息：编号、姓名、性别、出生日期、电话、身份证号
- 扩展信息：地址、紧急联系人、血型、过敏史、既往病史
- 时间戳：创建时间、更新时间

**就诊（Visit）**：
- 关联：患者、医生（可选）
- 信息：就诊编号、就诊时间、科室、主诉、诊断、状态
- 时间戳：创建时间、更新时间

**药品（Drug）**：
- 基本信息：编码、名称、分类、规格、单位
- 价格：采购价（成本价）、售价
- 其他：生产厂家、是否处方药、描述、启用状态
- 时间戳：创建时间、更新时间

**库存（Inventory）**：
- 数量：当前库存、预警级别
- 位置：存放位置/货架号
- 时间戳：更新时间

**处方（Prescription）**：
- 关联：就诊记录、开方医生（可选）
- 状态：草稿、已开具、已发药、已取消
- 时间：创建时间、开具时间、发药时间、更新时间
- 备注：处方备注

**处方项（PrescriptionItem）**：
- 关联：处方、药品
- 信息：数量、单价（冻结当时售价）、用法用量、备注
- 时间戳：创建时间、更新时间

**发票（Invoice）**：
- 关联：就诊记录、患者、开票人（财务人员，可选）
- 金额：总金额
- 状态：未支付、已支付、已退款
- 时间：创建时间、开票时间、支付完成时间、更新时间
- 备注：发票备注

**支付（Payment）**：
- 关联：发票、收款人（财务人员，可选）
- 信息：支付金额、支付方式、备注
- 时间：支付时间、更新时间

**职工档案（StaffProfile）**：
- 关联：用户账号（一对一）
- 基本信息：工号、姓名、岗位角色、科室
- 扩展信息：职位/职称、专业特长、电话、邮箱、地址、入职日期
- 状态：在职状态
- 时间戳：创建时间、更新时间

---

## 6. 技术方案（实现形态）
### 6.1 技术栈
- 后端：Django
- 数据库：MySQL（本次期末不涉及部署）
- 后台：Django Admin 
- 前端展示：HTML 模板

### 6.2 系统结构（目录）
- hospital_core：项目配置、路由
- patients：患者/就诊
- staff：职工/角色
- pharmacy：药品/库存/处方/发药
- finance：账单/支付

### 6.3 页面与路由（示例规划）
- /patients/（患者列表与搜索）
- /patients/<id>/（患者详情：就诊历史）
- /visits/new（创建就诊）
- /visits/<id>/（就诊详情：处方与账单入口）
- /pharmacy/drugs/（药品列表）
- /pharmacy/inventory/（库存与预警）
- /pharmacy/prescriptions/<id>/（处方详情）
- /pharmacy/dispense/<prescription_id>/create（发药扣库存）
- /finance/invoices/（账单列表）
- /finance/invoices/<id>/（账单详情+支付）

---

## 7. 里程碑计划（建议）
M1 数据建模完成：
- models 定稿 + migrations 可正常 migrate
- admin 注册核心模型

M2 MVP 闭环跑通：
- 患者建档 → 就诊 → 处方 → 发药扣库存 → 账单生成 → 支付

M3 界面完善与测试数据：
- Bootstrap 页面统一布局
- 生成测试数据（至少 2 科室、5 职工、3 患者、3 就诊、2 处方、1 发药、3 账单、2 支付）

M4 交付物整理：
- report.docx（项目介绍+数据库设计文档）
- init.sql（表结构+测试数据）
- 源码+静态资源打包

---

## 8. 验收标准（老师如何判你“完成”）
- 能正常启动项目并访问后台管理
- 数据表关系正确，外键/唯一约束存在
- 演示闭环：创建患者→创建就诊→开处方→发药扣库存→生成账单→登记支付
- SQL 文件可直接导入并得到结构+测试数据
- 文档清晰：项目介绍与数据库设计说明完整、逻辑合理

---

## 9. 交付物清单
1) docs/report.docx：包含
   - 项目介绍
   - 数据库设计文档
2) sql/init.sql：
   - CREATE TABLE（表结构）
   - INSERT INTO（测试数据）
3) 项目源代码：
   - Django 后端源码
   - 前端静态 HTML 页面及资源（static/templates）
4) medicalmanager.zip：
   - 将以上所有内容打包提交
